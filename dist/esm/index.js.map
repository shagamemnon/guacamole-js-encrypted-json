{"version":3,"file":"index.js","sources":["../../src/index.js"],"sourcesContent":["/* String to ArrayBuffer */\nconst str2ab = (str) => Uint8Array.from(str, (x) => x.charCodeAt(0));\n\n/* ArrayBuffer to String */\nconst ab2str = (buf) => String.fromCharCode(...new Uint8Array(buf));\n\nconst EncryptedJsonAuth = function (secretKey, jsonMsg) {\n  if (typeof jsonMsg !== \"string\") jsonMsg = JSON.stringify(jsonMsg);\n\n  const auth = {\n    secretKey,\n    jsonMsg,\n\n    set key(val) {\n      this.secretKey = val;\n    },\n\n    get key() {\n      return new Uint8Array(\n        this.secretKey.match(/[\\da-f]{2}/gi).map((h) => parseInt(h, 16))\n      );\n    },\n\n    /**\n     * @params jsonMsg - a standard Guacamole encrypted JSON object\n     * https://guacamole.apache.org/doc/gug/json-auth.html#json-format\n     *\n     */\n    async createHmac(jsonMsg) {\n      const key = await crypto.subtle.importKey(\n        \"raw\",\n        this.key,\n        { name: \"HMAC\", hash: \"SHA-256\" },\n        false,\n        [\"sign\"]\n      );\n\n      const mac = await crypto.subtle.sign(\n        \"HMAC\",\n        key,\n        new TextEncoder().encode(jsonMsg)\n      );\n      return ab2str(mac);\n    },\n\n    /**\n     * @params sig - the result of the HMAC signature\n     * @params authString - the plaintext JSON value\n     *\n     * Returns encrypts the concatenated result of sig + authString with AES-128-CBC\n     */\n    async encryptMessage(sig, authString) {\n      console.log(this);\n      const prependedSig = str2ab(sig + authString);\n      const key = await crypto.subtle.importKey(\n        \"raw\",\n        this.key,\n        \"AES-CBC\",\n        true,\n        [\"encrypt\", \"decrypt\"]\n      );\n      const ivBin = new ArrayBuffer(16);\n      const cipher = await crypto.subtle.encrypt(\n        { name: \"AES-CBC\", iv: ivBin },\n        key,\n        prependedSig\n      );\n      const cipherStr = ab2str(cipher);\n      return btoa(cipherStr);\n    },\n\n    async createToken(msg) {\n      if (!this.jsonMsg) {\n        this.jsonMsg = JSON.stringify(msg);\n      }\n      const signature = await this.createHmac(this.jsonMsg);\n      const encryptedSignature = await this.encryptMessage(\n        signature,\n        this.jsonMsg\n      );\n      const encryptedSignatureEncoded = encodeURIComponent(encryptedSignature);\n      console.log(encryptedSignature);\n      return encodeURIComponent(encryptedSignature);\n    },\n  };\n  return auth;\n};\n\nObject.create(Auth.prototype);\nAuth.prototype.constructor = Auth.prototype;\n\nconst signAndEncryptJson = (secretKey, jsonMsg) =>\n  new EncryptedJsonAuth(secretKey, jsonMsg);\n\nexport default EncryptedJsonAuth;\n\nexport { signAndEncryptJson };\n"],"names":[],"mappings":"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"}