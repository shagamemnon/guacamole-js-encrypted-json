{"version":3,"file":"guacamole-js-encrypted-json.min.js","sources":["../src/index.js"],"sourcesContent":["/* String to ArrayBuffer */\nconst str2ab = (str) => Uint8Array.from(str, (x) => x.charCodeAt(0));\n\n/* ArrayBuffer to String */\nconst ab2str = (buf) => String.fromCharCode(...new Uint8Array(buf));\n\nconst EncryptedJsonAuth = function (secretKey, jsonMsg) {\n  if (typeof jsonMsg !== \"string\") jsonMsg = JSON.stringify(jsonMsg);\n\n  const auth = {\n    secretKey,\n    jsonMsg,\n\n    set key(val) {\n      this.secretKey = val;\n    },\n\n    get key() {\n      return new Uint8Array(\n        this.secretKey.match(/[\\da-f]{2}/gi).map((h) => parseInt(h, 16))\n      );\n    },\n\n    /**\n     * @params jsonMsg - a standard Guacamole encrypted JSON object\n     * https://guacamole.apache.org/doc/gug/json-auth.html#json-format\n     *\n     */\n    async createHmac(jsonMsg) {\n      const key = await crypto.subtle.importKey(\n        \"raw\",\n        this.key,\n        { name: \"HMAC\", hash: \"SHA-256\" },\n        false,\n        [\"sign\"]\n      );\n\n      const mac = await crypto.subtle.sign(\n        \"HMAC\",\n        key,\n        new TextEncoder().encode(jsonMsg)\n      );\n      return ab2str(mac);\n    },\n\n    /**\n     * @params sig - the result of the HMAC signature\n     * @params authString - the plaintext JSON value\n     *\n     * Returns encrypts the concatenated result of sig + authString with AES-128-CBC\n     */\n    async encryptMessage(sig, authString) {\n      console.log(this);\n      const prependedSig = str2ab(sig + authString);\n      const key = await crypto.subtle.importKey(\n        \"raw\",\n        this.key,\n        \"AES-CBC\",\n        true,\n        [\"encrypt\", \"decrypt\"]\n      );\n      const ivBin = new ArrayBuffer(16);\n      const cipher = await crypto.subtle.encrypt(\n        { name: \"AES-CBC\", iv: ivBin },\n        key,\n        prependedSig\n      );\n      const cipherStr = ab2str(cipher);\n      return btoa(cipherStr);\n    },\n\n    async createToken(msg) {\n      if (!this.jsonMsg) {\n        this.jsonMsg = JSON.stringify(msg);\n      }\n      const signature = await this.createHmac(this.jsonMsg);\n      const encryptedSignature = await this.encryptMessage(\n        signature,\n        this.jsonMsg\n      );\n      const encryptedSignatureEncoded = encodeURIComponent(encryptedSignature);\n      console.log(encryptedSignature);\n      return encodeURIComponent(encryptedSignature);\n    },\n  };\n  return auth;\n};\n\nObject.create(Auth.prototype);\nAuth.prototype.constructor = Auth.prototype;\n\nconst signAndEncryptJson = (secretKey, jsonMsg) =>\n  new EncryptedJsonAuth(secretKey, jsonMsg);\n\nexport default EncryptedJsonAuth;\n\nexport { signAndEncryptJson };\n"],"names":["ab2str","buf","String","fromCharCode","apply","_toConsumableArray","Uint8Array","EncryptedJsonAuth","secretKey","jsonMsg","JSON","stringify","auth","key","val","this","match","map","h","parseInt","createHmac","_this","_asyncToGenerator","_regeneratorRuntime","mark","_callee","mac","wrap","_context","prev","next","crypto","subtle","importKey","name","hash","sent","sign","TextEncoder","encode","abrupt","stop","encryptMessage","sig","authString","_this2","_callee2","prependedSig","ivBin","cipher","cipherStr","_context2","console","log","str","from","x","charCodeAt","ArrayBuffer","encrypt","iv","btoa","createToken","msg","_this3","_callee3","signature","encryptedSignature","_context3","encodeURIComponent","Object","create","Auth","prototype","constructor"],"mappings":"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"}